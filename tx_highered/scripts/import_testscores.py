"""

Sample CSV structure:
UnitID,Institution Name,ENRLT(IC2011),APPLCN(IC2011),ADMSSN(IC2011),SATNUM(IC2011),SATPCT(IC2011),ACTNUM(IC2011),ACTPCT(IC2011),SATVR25(IC2011),SATVR75(IC2011),SATMT25(IC2011),SATWR25(IC2011),SATWR75(IC2011),SATMT75(IC2011),ACTCM25(IC2011),ACTCM75(IC2011),ACTEN25(IC2011),ACTEN75(IC2011),ACTMT25(IC2011),ACTMT75(IC2011),ACTWR25(IC2011),ACTWR75(IC2011),ENRLT(IC2010_RV),APPLCN(IC2010_RV),ADMSSN(IC2010_RV),SATNUM(IC2010_RV),SATPCT(IC2010_RV),ACTNUM(IC2010_RV),ACTPCT(IC2010_RV),SATVR25(IC2010_RV),SATVR75(IC2010_RV),SATMT25(IC2010_RV),SATWR25(IC2010_RV),SATWR75(IC2010_RV),SATMT75(IC2010_RV),ACTCM25(IC2010_RV),ACTCM75(IC2010_RV),ACTEN25(IC2010_RV),ACTEN75(IC2010_RV),ACTMT25(IC2010_RV),ACTMT75(IC2010_RV),ACTWR25(IC2010_RV),ACTWR75(IC2010_RV),ENRLT(IC2009_RV),APPLCN(IC2009_RV),ADMSSN(IC2009_RV),SATNUM(IC2009_RV),SATPCT(IC2009_RV),ACTNUM(IC2009_RV),ACTPCT(IC2009_RV),SATVR25(IC2009_RV),SATVR75(IC2009_RV),SATMT25(IC2009_RV),SATWR25(IC2009_RV),SATWR75(IC2009_RV),SATMT75(IC2009_RV),ACTCM25(IC2009_RV),ACTCM75(IC2009_RV),ACTEN25(IC2009_RV),ACTEN75(IC2009_RV),ACTMT25(IC2009_RV),ACTMT75(IC2009_RV),ACTWR25(IC2009_RV),ACTWR75(IC2009_RV),ENRLT(IC2008),APPLCN(IC2008),ADMSSN(IC2008),SATNUM(IC2008),SATPCT(IC2008),ACTNUM(IC2008),ACTPCT(IC2008),SATVR25(IC2008),SATVR75(IC2008),SATMT25(IC2008),SATWR25(IC2008),SATWR75(IC2008),SATMT75(IC2008),ACTCM25(IC2008),ACTCM75(IC2008),ACTEN25(IC2008),ACTEN75(IC2008),ACTMT25(IC2008),ACTMT75(IC2008),ACTWR25(IC2008),ACTWR75(IC2008),ENRLT(IC2007),APPLCN(IC2007),ADMSSN(IC2007),SATNUM(IC2007),SATPCT(IC2007),ACTNUM(IC2007),ACTPCT(IC2007),SATVR25(IC2007),SATVR75(IC2007),SATMT25(IC2007),SATWR25(IC2007),SATWR75(IC2007),SATMT75(IC2007),ACTCM25(IC2007),ACTCM75(IC2007),ACTEN25(IC2007),ACTEN75(IC2007),ACTMT25(IC2007),ACTMT75(IC2007),ENRLT(IC2006),APPLCN(IC2006),ADMSSN(IC2006),SATNUM(IC2006),SATPCT(IC2006),ACTNUM(IC2006),ACTPCT(IC2006),SATVR25(IC2006),SATVR75(IC2006),SATMT25(IC2006),SATWR25(IC2006),SATWR75(IC2006),SATMT75(IC2006),ACTCM25(IC2006),ACTCM75(IC2006),ACTEN25(IC2006),ACTEN75(IC2006),ACTMT25(IC2006),ACTMT75(IC2006),ENRLT(IC2005),APPLCN(IC2005),ADMSSN(IC2005),SATNUM(IC2005),SATPCT(IC2005),ACTNUM(IC2005),ACTPCT(IC2005),SATVR25(IC2005),SATVR75(IC2005),SATMT25(IC2005),SATMT75(IC2005),ACTCM25(IC2005),ACTCM75(IC2005),ACTEN25(IC2005),ACTEN75(IC2005),ACTMT25(IC2005),ACTMT75(IC2005),ENRLT(IC2004),APPLCN(IC2004),ADMSSN(IC2004),SATNUM(IC2004),SATPCT(IC2004),ACTNUM(IC2004),ACTPCT(IC2004),SATVR25(IC2004),SATVR75(IC2004),SATMT25(IC2004),SATMT75(IC2004),ACTCM25(IC2004),ACTCM75(IC2004),ACTEN25(IC2004),ACTEN75(IC2004),ACTMT25(IC2004),ACTMT75(IC2004),ENRLT(IC2003),APPLCN(IC2003),ADMSSN(IC2003),SATNUM(IC2003),SATPCT(IC2003),ACTNUM(IC2003),ACTPCT(IC2003),SATVR25(IC2003),SATVR75(IC2003),SATMT25(IC2003),SATMT75(IC2003),ACTCM25(IC2003),ACTCM75(IC2003),ACTEN25(IC2003),ACTEN75(IC2003),ACTMT25(IC2003),ACTMT75(IC2003),ENRLT(IC2002),APPLCN(IC2002),ADMSSN(IC2002),SATNUM(IC2002),SATPCT(IC2002),ACTNUM(IC2002),ACTPCT(IC2002),SATVR25(IC2002),SATVR75(IC2002),SATMT25(IC2002),SATMT75(IC2002),ACTCM25(IC2002),ACTCM75(IC2002),ACTEN25(IC2002),ACTEN75(IC2002),ACTMT25(IC2002),ACTMT75(IC2002),ENRLT(IC2001),APPLCN(IC2001),ADMSSN(IC2001),SATNUM(IC2001),SATPCT(IC2001),ACTNUM(IC2001),ACTPCT(IC2001),SATVR25(IC2001),SATVR75(IC2001),SATMT25(IC2001),SATMT75(IC2001),ACTCM25(IC2001),ACTCM75(IC2001),ACTEN25(IC2001),ACTEN75(IC2001),ACTMT25(IC2001),ACTMT75(IC2001),
222178,Abilene Christian University,864,3470,2234,343,40,519,60,490,620,505,,,610,22,28,21,29,21,27,,,980,4106,2157,533,54,445,45,500,610,510,,,520,22,28,21,29,21,27,,,983,3712,1823,533,55,447,45,480,600,490,,,620,21,27,20,28,20,26,,,971,3897,1820,531,55,433,45,485,610,490,,,615,21,27,21,28,20,27,,,892,3900,1840,456,51,431,48,480,610,490,,,620,20,26,20,27,19,26,963,3661,1914,497,52,462,48,480,620,490,,,630,20,27,20,28,19,26,1031,3825,2097,596,58,430,42,490,623,490,630,20,26,20,27,19,25,1020,3694,1988,530,52,463,45,490,630,490,620,20,27,20,28,19,26,950,4011,2117,513,54,432,45,490,600,490,610,21,26,21,27,19,26,941,3029,1855,729,77,678,72,480,610,470,610,20,26,19,27,18,26,1031,3056,2004,488,47,520,50,490,610,490,610,21,27,21,28,19,26,
"""

import csv
import re
import sys
from collections import defaultdict

from tx_highered.models import Institution, TestScores

path = sys.argv[1]

reader = csv.reader(open(path, "rb"))


FIELD_MAPPING = (
    ('SATNUM', 'students_submitting_sat_scores_number'),
    ('SATPCT', 'students_submitting_sat_scores_percent'),
    ('ACTNUM', 'students_submitting_act_scores_number'),
    ('ACTPCT', 'students_submitting_act_scores_percent'),
    ('SATVR25', 'sat_verbal_25th_percentile'),
    ('SATVR75', 'sat_verbal_75th_percentile'),
    ('SATMT25', 'sat_math_25th_percentile'),
    ('SATMT75', 'sat_math_75th_percentile'),
    ('SATWR25', 'sat_writing_25th_percentile'),
    ('SATWR75', 'sat_writing_75th_percentile'),
    ('ACTCM25', 'act_composite_25th_percentile'),
    ('ACTCM75', 'act_composite_75th_percentile'),
    ('ACTEN25', 'act_english_25th_percentile'),
    ('ACTEN75', 'act_english_75th_percentile'),
    ('ACTMT25', 'act_math_25th_percentile'),
    ('ACTMT75', 'act_math_75th_percentile'),
    ('ACTWR25', 'act_writing_25th_percentile'),
    ('ACTWR75', 'act_writing_75th_percentile'))
PRIMARY_MAPPING = ('UnitID', 'ipeds_id')
YEAR_TYPE = 'fall'

# process header
header = reader.next()
years = defaultdict(list)
fields = dict(FIELD_MAPPING)
primary_idx = None
for idx, cell in enumerate(header):
    if cell == PRIMARY_MAPPING[0]:
        primary_idx = idx
        continue
    try:
        name, year = re.match(r'(\w+)\([a-zA-Z]+(\d+)', cell).groups()
    except AttributeError:
        continue
    if name in fields:
        years[year].append((idx, fields[name]))

for row in reader:
    inst = Institution.objects.get(ipeds_id=row[primary_idx])
    for year in years:
        instance, _ = TestScores.objects.get_or_create(institution=inst, year=year,
            defaults=dict(year_type=YEAR_TYPE))
        for idx, name in years[year]:
            if row[idx]:
                setattr(instance, name, row[idx])
        instance.save()
        print instance

