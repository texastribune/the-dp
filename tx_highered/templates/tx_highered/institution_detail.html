{% extends "tx_highered/two_column_base.html" %}
{% load layout_helpers humanize instachart %}
{% load webdesign %}


{% block head_title %}{{ object.name }}{% endblock %}
{% block page_title %}{{ object.name }}{% endblock %}


{% block header %}
  <div class="row">
    <div class="span9">
      {% include "tx_highered/includes/sentences.html" %}
    </div>

    <div class="span3">
      {% render_model object "quick-stats" %}
    </div>
  </div>
{% endblock %}

{% block main %}
  <section id="pricetrends">
    <h3>Price Trends <small class="page-anchor"><a href="#pricetrends"><i class="icon-share"></i></a></small></h3>
    <p>{% lorem 20 w %}</p>
    {% instachart object.pricetrends.all "pricetrends" %}
  </section>

  <section id="testing">
    <h3>Test Scores <small class="page-anchor"><a href="#testing"><i class="icon-share"></i></a></small></h3>
    {% instachart object.testscores.all "testscores" %}
  </section>

  <section id="admissions">
    <h3>Admissions <small class="page-anchor"><a href="#admissions"><i class="icon-share"></i></a></small></h3>
    {% with object_list=object.admissions.all %}
      {% include "instachart/admissions/admissions.html" %}
    {% endwith %}

    <div class="d3-viz"></div>
  </section>

  <h3>Enrollment</h3>
  {% instachart object.enrollment.all %}

  <h3>Graduation Rates</h3>
  {% instachart object.graduationrates.all "graduationrates" %}
{% endblock %}

{% block extra_script %}{{ block.super }}
<script src="{{ STATIC_URL }}js/bootstrap-tooltip-d3.js"></script>
<script src="{{ STATIC_URL }}tx_highered/js/tabbouleh.js"></script>
<script src="{{ STATIC_URL }}tx_highered/js/barchart.js"></script>
<script src="{{ STATIC_URL }}tx_highered/js/admissions-chart.js"></script>
<script>
  var $source = $('#pricetrends table');
  var data = $source.tabulate();

  // store

  var chart = d3BarChart($('<div class="chart" />').insertAfter($source)[0],
      [data[0], data[3], data[2]],
      {
        'style': 'stacked',
        'tooltip': function(){
          var d = this.__data__;
          return d.series + " " + d.x + " <b>$" + d3.format(",.0f")(d.y) + "</b>";
        }
      });
  $source.find('th:eq(1)').click(function(){
    chart.data([data[0], data[3], data[2]]);
  });
  $source.find('th:eq(2)').click(function(){
    chart.data([data[1], data[3], data[2]]);
  });

  var chart2 = d3BarChart($('<div class="chart" />').insertAfter(chart.elem)[0],
              [data[0], data[1]], {
                'style': 'grouped'
              });
  var x_array = data[0].map(function(a){ return a.x; });
  var oldTooltip = chart2.option('tooltip');
  var oldYFormat = chart2.yAxis.tickFormat();
  var hoverTooltip = function(){
        var d = this.__data__;
        return d.series + " <b>" + d3.format(",.2f")(this.__data__.y - 100) + "%</b>";
      };
  chart2.plot.selectAll('rect.bar').on("click", function(){
    var idx = x_array.indexOf(this.__data__.x);
    if (idx === -1) { console.error("couldn't find index", x_array, this.__data__); return; }
    var normData = normalizeFirst([data[0], data[1]], idx);
    chart2.option('tooltip', hoverTooltip);
    chart2.yAxis.tickFormat(function(a){ return a - 100 + '%'; });
    chart2.data(normData);
    // add sea-level line
    var s = chart2.yAxis.scale();
    chart2.plot.selectAll('line.sealevel')
      .data([100, 200, 300, 400])
        .enter().append('line').attr('class', 'sealevel')
          .attr('x1', 0)
          .attr('x2', '100%')
          .attr('y1', 0)
          .attr('y2', 0)
          .attr('stroke-opacity', 0)
          .attr("transform", function(d){ return "translate(0, " + s(d) + ")"; });
    chart2.plot.selectAll('line.sealevel')  // called after .enter() AND updates
      .transition()
        .attr("transform", function(d){ return "translate(0, " + s(d) + ")"; })
        .attr('stroke-opacity', 100);
  });
  $(chart2.elem).on("dblclick", function(){
    chart2.option('tooltip', oldTooltip);
    chart2.yAxis.tickFormat(oldYFormat);
    chart2.data([data[0], data[1]]);
    // remove sea-level line
    chart2.svg.selectAll('line.sealevel').data([]).exit()
      .transition()
        .attr('stroke-opacity', 0)
        .remove();
  });

  $('table').tablebars();
  $(".onion").onionize();
</script>
{% endblock %}
